<ksp-top-nav>
  <span header>{{ pageType === 'studentList' ? headerStudent.h1 : headerGraduate.h1 }}</span>
  <span subHeader>{{ pageType === 'studentList' ? headerStudent.h2 : headerGraduate.h2 }}</span>
  <span detail> > {{ pageType === 'studentList' ? headerStudent.h3 : headerGraduate.h3 }}</span>
</ksp-top-nav>

<div class="bg-secondary bg-opacity-10 px-4 py-2 full-height full-width-2">
  <div class="box-header">รายละเอียดใบคำขอ</div>

  <div class="bg-white p-3">
    <ksp-request-header-info
      [requestDate]="requestDate"
      [requestNumber]="requestNo"
    ></ksp-request-header-info>
    <hr />

    <div class="d-flex justify-content-between mb-1">
      <div class="box-header">{{ pageType === 'studentList' ? headerStudent.h3 : headerGraduate.h3 }}</div>
      <div *ngIf="pageType === 'studentList'">
        <button
          type="button"
          (click)="downloadfile()"
          class="btn border-success text-success w-auto me-2"
        >
          <img src="/assets/images/img-uni/microsoft excel.png" />
          ดาวน์โหลดแบบฟอร์ม
        </button>

        <ng-container>
          <button
            (click)="fileUpload.click()"
            type="button"
            class="btn btn-sm btn-primary w-auto"
          >
            <img src="/assets/images/img-uni/Upload.svg" /> อัปโหลดไฟล์
          </button></ng-container
        >
        <input
          hidden="true"
          type="file"
          (change)="onFileSelected($event)"
          #fileUpload
        />
      </div>
    </div>

    <form [formGroup]="formStudent">
      <div formArrayName="user">
        <p-table
          [value]="user.controls"
          responsiveLayout="scroll"
          dataKey="controls.index.value"
          editMode="row"
          #dt
        >
          <ng-template pTemplate="header">
            <tr>
              <th
                class="p-2 text-nowrap align-text-top"
                *ngIf="pageType === 'graduateList'"
              >
                เลือก
              </th>
              <th
                class="p-2 text-nowrap align-text-top"
                *ngIf="pageType === 'studentList'"
              >
                ลำดับ
              </th>
              <th
                class="p-2 text-nowrap align-text-top"
                *ngIf="pageType === 'graduateList'"
              >
                ครั้งที่สภาอนุมัติ
              </th>
              <th
                class="p-2 text-nowrap align-text-top"
                *ngIf="pageType === 'graduateList'"
              >
                วันที่สภาอนุมัติ
              </th>
              <th
                class="p-2 text-nowrap align-text-top"
                *ngIf="pageType === 'graduateList'"
              >
                วันที่จบการศึกษา
              </th>
              <th
                class="p-2 text-nowrap align-text-top"
                *ngIf="pageType === 'graduateList'"
              >
                สถานที่ปฏิบัติการสอน
              </th>
              <th
                class="p-2 text-nowrap align-text-top"
                *ngIf="pageType === 'studentList'"
              >
                วันที่รับเข้า
              </th>
              <th
                class="p-2 text-nowrap"
                *ngIf="pageType === 'graduateList'"
              >
                <div>
                  <label>วันที่เข้ารับการศึกษา</label>
                  <input 
                    pInputText 
                    type="date" 
                    class="form-control form-search" 
                    (input)="dt.filter($any($event.target).value, 'admissiondate', 'contains')" />
                </div>
              </th>
  
              <th
                class="p-2 text-nowrap"
                *ngIf="pageType === 'studentList'"
              >
                เลขบัตรประจำตัวประชาชน /<br />
                เลขประจำตัวคุรุสภา
              </th>
  
              <th
                class="p-2 text-nowrap"
                *ngIf="pageType === 'graduateList'"
              >
                <div>
                  เลขบัตรประจำตัวประชาชน
                  <input 
                    pInputText 
                    type="text" 
                    class="form-control form-search" 
                    (input)="dt.filter($any($event.target).value, 'idcardno', 'contains')" />
                </div>
              </th>
  
              <th class="p-2 text-nowrap align-text-top">
                หมายเลขหนังสือเดินทาง
                <input 
                  pInputText 
                  type="text" 
                  class="form-control form-search" 
                  *ngIf="pageType === 'graduateList'"
                  (input)="dt.filter($any($event.target).value, 'passportno', 'contains')" />
              </th>
              <th
                class="p-2 text-nowrap align-text-top"
                *ngIf="pageType === 'studentList'"
              >
                สัญชาติ
              </th>
  
              <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
                คำนำหน้าชื่อ
              </th>
  
              <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
                ชื่อ (ภาษาไทย)
                <div>
                  <input 
                    pInputText 
                    type="text" 
                    class="form-control form-search" 
                    *ngIf="pageType === 'graduateList'"
                    (input)="dt.filter($any($event.target).value, 'firstnameth', 'contains')" />
                </div>
              </th>
  
              <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
                นามสกุล (ภาษาไทย)
                <div>
                  <input 
                    pInputText 
                    type="text" 
                    class="form-control form-search" 
                    *ngIf="pageType === 'graduateList'"
                    (input)="dt.filter($any($event.target).value, 'lastnameth', 'contains')" />
                </div>
              </th>
  
              <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
                คำนำหน้าชื่อ
              </th>
  
              <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
                ชื่อ (ภาษาอังกฤษ)
                <div>
                  <input 
                    pInputText 
                    type="text" 
                    class="form-control form-search" 
                    *ngIf="pageType === 'graduateList'"
                    (input)="dt.filter($any($event.target).value, 'firstnameen', 'contains')" />
                </div>
              </th>
  
              <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
                ชื่อกลาง (ภาษาอังกฤษ)
                <div>
                  <input 
                    pInputText 
                    type="text" 
                    class="form-control form-search"
                    *ngIf="pageType === 'graduateList'"
                    (input)="dt.filter($any($event.target).value, 'middlenameen', 'contains')" />
                </div>
              </th>
  
              <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
                นามสกุล (ภาษาอังกฤษ)
                <div>
                  <input 
                    pInputText 
                    type="text" 
                    class="form-control form-search" 
                    *ngIf="pageType === 'graduateList'"
                    (input)="dt.filter($any($event.target).value, 'lastnameen', 'contains')" />
                </div>
              </th>
  
              <th class="p-2 text-nowrap align-text-top">
                เบอร์โทรศัพท์มือถือ
                <input 
                  pInputText 
                  type="text" 
                  class="form-control form-search" 
                  *ngIf="pageType === 'graduateList'"
                  (input)="dt.filter($any($event.target).value, 'phone', 'contains')" />
              </th>
              <th class="p-2 text-nowrap align-text-top">
                วัน/เดือน/ปีเกิด(พ.ศ.)
              </th>
              <th class="p-2 text-nowrap align-text-top">ที่อยู่</th>
              <th
                class="p-2 text-nowrap align-text-top"
                *ngIf="pageType === 'studentList'"
              >
                รายวิชา
              </th>
              <th class="p-2 text-nowrap"></th>
            </tr>
          </ng-template>
          <ng-template
            pTemplate="body"
            let-control
            let-editing="editing"
            let-ri="rowIndex"
            let-expanded="expanded"
          >
            <tr [formGroupName]="ri">
              <td
                class="p-2 text-nowrap"
                *ngIf="pageType === 'studentList'"
              >
              {{ control.value.no }}
              </td>

              <td
                class="text-center"
                *ngIf="pageType === 'graduateList'"
              >
                <input type="checkbox" 
                  formControlName="checked"
                  class="form-check-input" />
              </td>

              <td
                class="p-2 text-nowrap"
                *ngIf="pageType === 'graduateList'"
              >
                <input
                  class="form-control text-center"
                  style="width: 75px"
                  pInputText
                  type="text"
                  formControlName="approveno"
                />
              </td>
              <td
                class="p-2 text-nowrap"
                *ngIf="pageType === 'graduateList'"
              >
                <input
                  class="form-control"
                  style="width: 150px"
                  pInputText
                  type="date"
                  formControlName="approvedate"
                />
              </td>
              <td
                class="p-2 text-nowrap"
                *ngIf="pageType === 'graduateList'"
              >
                <input
                  class="form-control"
                  style="width: 150px"
                  pInputText
                  type="date"
                  formControlName="graduationdate"
                />
              </td>

              <td
                class="p-2 text-nowrap"
                *ngIf="pageType === 'graduateList'"
              >
                <div
                  (click)="searchAddress(control.value.index)"
                  class="text-orange text-decoration-underline whitespace-nowrap"
                  role="button"
                >
                  สถานที่ปฏิบัติการสอน
                </div>
              </td>

              <td class="p-2 text-nowrap">
                <input
                class="form-control"
                style="width: 150px"
                pInputText
                type="date"
                formControlName="admissiondate"
                [readonly]="pageType === 'graduateList'"
              />
              </td>
              <td class="p-2 text-nowrap">
                <input
                  class="form-control"
                  style="width: 175px"
                  pInputText
                  #idcard
                  type="text"
                  formControlName="idcardno"
                  (blur)="searchByIdcard(
                    {idcardno: idcard.value, passportno: control.value.passportno}, control.value.index
                  )"
                  (keyup.enter)="idcard.blur();"
                  [readonly]="pageType === 'graduateList'"
                />
              </td>
              <td class="p-2 text-nowrap">
                <input
                  class="form-control"
                  style="width: 175px"
                  pInputText
                  #passport
                  type="text"
                  formControlName="passportno"
                  (blur)="searchByIdcard(
                    {idcardno: control.value.idcardno, passportno: passport.value}, control.value.index
                  )"
                  (keyup.enter)="passport.blur();"
                  [readonly]="pageType === 'graduateList'"
                />
              </td>

              <td
                class="p-2 text-nowrap"
                *ngIf="pageType === 'studentList'"
              >
                <select 
                  class="form-select" 
                  style="width: 150px"
                  formControlName="nationality">
                  <option value="null" selected hidden disabled>กรุณาเลือก</option>
                  <option
                    *ngFor="let nation of nationality"
                    [value]="nation.nationId"
                  >
                    {{ nation.nationName }}
                  </option>
                </select>
              </td>

              <td class="p-2 text-nowrap">
                <select
                  class="form-select"
                  style="width: 100px"
                  [attr.disabled]="pageType === 'graduateList' ? '':null"
                  formControlName="prefixth"
                >
                  <option value="null" selected hidden disabled>กรุณาเลือก</option>
                  <option
                    *ngFor="let ThPrefix of ThPrefixes"
                    [value]="ThPrefix.id"
                  >
                    {{ ThPrefix.name_th }}
                  </option>
                </select>
              </td>

              <td class="p-2 text-nowrap">
                <input
                  class="form-control"
                  style="width: 150px"
                  pInputText
                  type="text"
                  formControlName="firstnameth"
                  [readonly]="pageType === 'graduateList'"
                />
              </td>
              <td class="p-2 text-nowrap">
                <input
                  class="form-control"
                  style="width: 150px"
                  pInputText
                  type="text"
                  formControlName="lastnameth"
                  [readonly]="pageType === 'graduateList'"
                />
              </td>
              <td class="p-2 text-nowrap">
                <select
                  class="form-select"
                  style="width: 100px"
                  [attr.disabled]="pageType === 'graduateList' ? '':null"
                  formControlName="prefixen"
                >
                  <option value="null" selected hidden disabled>กรุณาเลือก</option>
                  <option
                    *ngFor="let EngPrefix of EngPrefixes"
                    [value]="EngPrefix.id"
                  >
                    {{ EngPrefix.name_en }}
                  </option>
                </select>
              </td>

              <td class="p-2 text-nowrap">
                <input
                  class="form-control"
                  style="width: 150px"
                  pInputText
                  type="text"
                  formControlName="firstnameen"
                  [readonly]="pageType === 'graduateList'"
                />
              </td>

              <td class="p-2 text-nowrap">
                <input
                  class="form-control"
                  style="width: 150px"
                  pInputText
                  type="text"
                  formControlName="middlenameen"
                  [readonly]="pageType === 'graduateList'"
                />
              </td>

              <td class="p-2 text-nowrap">
                <input
                  class="form-control"
                  style="width: 150px"
                  pInputText
                  type="text"
                  formControlName="lastnameen"
                  [readonly]="pageType === 'graduateList'"
                />
              </td>

              <td class="p-2 text-nowrap">
                <input
                  class="form-control"
                  style="width: 150px"
                  pInputText
                  type="text"
                  formControlName="phone"
                  [readonly]="pageType === 'graduateList'"
                />
              </td>
              <td class="p-2 text-nowrap">
                <input
                  class="form-control"
                  style="width: 150px"
                  pInputText
                  type="date"
                  formControlName="birthdate"
                  [readonly]="pageType === 'graduateList'"
                />
              </td>

              <td class="p-2 text-nowrap">
                <div
                  *ngIf="pageType === 'studentList'"
                  role="button"
                  class="text-orange text-decoration-underline whitespace-nowrap"
                  [pRowToggler]="control"
                >
                  รายละเอียดที่อยู่
                </div>

                <div
                  class="text-orange text-decoration-underline whitespace-nowrap"
                  role="button"
                  *ngIf="pageType === 'graduateList'"
                  (click)="viewAdress(control.value.address)"
                >
                  รายละเอียดที่อยู่
                </div>
              </td>

              <td
                class="p-2 text-nowrap"
                *ngIf="pageType === 'studentList'"
              >
                <div
                  class="text-orange text-decoration-underline whitespace-nowrap"
                  role="button"
                  (click)="insertSubject(control.value.subjects, ri)"
                >
                  รายวิชา
                </div>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="rowexpansion" let-control let-ii="rowIndex">
            <tr [formGroupName]="ii">
              <td></td>
              <td colspan="8">
                <form [formGroup]="getForm(ii)">
                  <ksp-form-address-table formControlName="addressInfo"></ksp-form-address-table>
                </form>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </form>
    <div class="mt-2" *ngIf="pageType === 'studentList' && users.length < courseData?.courseSelected.student">
      <ksp-add-row-button class="blue" (click)="addStudent()">เพิ่มรายชื่อ</ksp-add-row-button>
    </div>
  </div>
</div>

<div class="sticky-bottom border">
  <ksp-bottom-nav
    [isLastPage]="true"
    [isFirstPage]="true"
    [showCenterButtons]="true"
    [showSaveButton]="true"
    [showTempSaveButton]="true"
    [disableTempSaveButton]="checkdisableSave()"
    (saveClicked)="save('send')"
    (cancelClicked)="cancel()"
    (tempSaveClicked)="save('temp')"
    [disableSaveButton]="checkdisableSave()"
    [saveButtonLabel]="'บันทึกและยื่นใบคำขอ'"
  ></ksp-bottom-nav>
</div>
