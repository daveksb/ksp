<form [formGroup]="formStudent">
  <div class="d-flex justify-content-between align-items-center">
    <div class="box-header">
      {{ data.pageType === 'admissionList' ? 'ประวัติการยื่นรายชื่อผู้เข้าศึกษา' : 'ประวัติการยื่นรายชื่อผู้สำเร็จการศึกษา' }}
    </div>
    <div>
      <i role="button" class="bi bi-x-lg text-primary" matDialogClose></i>
    </div>
  </div>
  <hr />
  <div formArrayName="user">
    <p-table
      [value]="user.controls"
      responsiveLayout="scroll"
      dataKey="controls.index.value"
      editMode="row"
      #dt
    >
      <ng-template pTemplate="header">
        <tr>
          <th
            class="p-2 text-nowrap align-text-top"
            *ngIf="data.pageType === 'graduateList'"
          >
            เลือก
          </th>
          <th
            class="p-2 text-nowrap align-text-top"
            *ngIf="data.pageType === 'admissionList'"
          >
            ลำดับ
          </th>
          <th
            class="p-2 text-nowrap align-text-top"
            *ngIf="data.pageType === 'graduateList'"
          >
            ครั้งที่สภาอนุมัติ
          </th>
          <th
            class="p-2 text-nowrap align-text-top"
            *ngIf="data.pageType === 'graduateList'"
          >
            วันที่สภาอนุมัติ
          </th>
          <th
            class="p-2 text-nowrap align-text-top"
            *ngIf="data.pageType === 'graduateList'"
          >
            วันที่จบการศึกษา
          </th>
          <th
            class="p-2 text-nowrap align-text-top"
            *ngIf="data.pageType === 'graduateList'"
          >
            สถานที่ปฏิบัติการสอน
          </th>
          <th
            class="p-2 text-nowrap align-text-top"
            *ngIf="data.pageType === 'admissionList'"
          >
            วันที่รับเข้า
          </th>
          <th class="p-2 text-nowrap" *ngIf="data.pageType === 'graduateList'">
            <div>
              <label>วันที่เข้ารับการศึกษา</label>
            </div>
          </th>

          <th class="p-2 text-nowrap" *ngIf="data.pageType === 'admissionList'">
            เลขบัตรประจำตัวประชาชน /<br />
            เลขประจำตัวคุรุสภา
          </th>

          <th class="p-2 text-nowrap" *ngIf="data.pageType === 'graduateList'">
            <div>
              เลขบัตรประจำตัวประชาชน
            </div>
          </th>

          <th class="p-2 text-nowrap align-text-top">
            หมายเลขหนังสือเดินทาง
          </th>
          <th
            class="p-2 text-nowrap align-text-top"
            *ngIf="data.pageType === 'admissionList'"
          >
            สัญชาติ
          </th>

          <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
            คำนำหน้าชื่อ (ภาษาไทย)
          </th>

          <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
            ชื่อ (ภาษาไทย)
          </th>

          <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
            นามสกุล (ภาษาไทย)
          </th>

          <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
            คำนำหน้าชื่อ (ภาษาอังกฤษ)
          </th>

          <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
            ชื่อ (ภาษาอังกฤษ)
          </th>

          <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
            ชื่อกลาง (ภาษาอังกฤษ)
          </th>

          <th class="p-2 text-nowrap align-text-top" style="width: 5rem">
            นามสกุล (ภาษาอังกฤษ)
          </th>

          <th class="p-2 text-nowrap align-text-top">
            เบอร์โทรศัพท์มือถือ
          </th>
          <th class="p-2 text-nowrap align-text-top">
            วัน/เดือน/ปีเกิด(พ.ศ.)
          </th>
          <th class="p-2 text-nowrap align-text-top">ที่อยู่</th>
          <th
            class="p-2 text-nowrap align-text-top"
            *ngIf="data.pageType === 'admissionList'"
          >
            รายวิชา
          </th>
          <th class="p-2 text-nowrap"></th>
        </tr>
      </ng-template>
      <ng-template
        pTemplate="body"
        let-control
        let-editing="editing"
        let-ri="rowIndex"
        let-expanded="expanded"
      >
        <tr [formGroupName]="ri">
          <td class="p-2 text-nowrap" *ngIf="data.pageType === 'admissionList'">
            {{ control.value.no }}
          </td>

          <td class="text-center" *ngIf="data.pageType === 'graduateList'">
            <input
              type="checkbox"
              formControlName="checked"
              class="form-check-input"
              readonly
            />
          </td>

          <td class="p-2 text-nowrap" *ngIf="data.pageType === 'graduateList'">
            <input
              class="form-control text-center"
              style="width: 75px"
              pInputText
              type="text"
              formControlName="approveno"
              readonly
            />
          </td>
          <td class="p-2 text-nowrap" *ngIf="data.pageType === 'graduateList'">
            <div class="d-flex align-items-center">
              <input
                [matDatepicker]="pickerapprovedate"
                style="width: 150px"
                autocomplete="off"
                class="form-control form-date"
                formControlName="approvedate"
                readonly
              />
              <mat-datepicker-toggle
                class="button-date"
                matSuffix
                [for]="pickerapprovedate"
              ></mat-datepicker-toggle>
              <mat-datepicker #pickerapprovedate disabled></mat-datepicker>
            </div>
            <!-- <input
              class="form-control"
              style="width: 150px"
              pInputText
              type="date"
              formControlName="approvedate"
            /> -->
          </td>
          <td class="p-2 text-nowrap" *ngIf="data.pageType === 'graduateList'">
            <div class="d-flex align-items-center">
              <input
                [matDatepicker]="pickergraduatedate"
                style="width: 150px"
                autocomplete="off"
                class="form-control form-date"
                formControlName="graduationdate"
                readonly
              />
              <mat-datepicker-toggle
                class="button-date"
                matSuffix
                [for]="pickergraduatedate"
              ></mat-datepicker-toggle>
              <mat-datepicker #pickergraduatedate disabled></mat-datepicker>
            </div>
            <!-- <input
              class="form-control"
              style="width: 150px"
              pInputText
              type="date"
              formControlName="graduationdate"
            /> -->
          </td>

          <td class="p-2 text-nowrap" *ngIf="data.pageType === 'graduateList'">
            <div
              (click)="searchAddress(control.value.index, control.value.locked)"
              class="text-orange text-decoration-underline whitespace-nowrap"
              role="button"
            >
              สถานที่ปฏิบัติการสอน
            </div>
          </td>

          <td class="p-2 text-nowrap">
            <div class="d-flex align-items-center">
              <input
                [matDatepicker]="picker"
                style="width: 150px"
                autocomplete="off"
                class="form-control form-date"
                formControlName="admissiondate"
                [readonly]="data.pageType === 'graduateList' || control.value.locked"
              />
              <mat-datepicker-toggle
                class="button-date"
                matSuffix
                [for]="picker"
              ></mat-datepicker-toggle>
              <mat-datepicker 
                #picker 
                [disabled]="data.pageType === 'graduateList' || control.value.locked"></mat-datepicker>
            </div>
            <!-- <input
              class="form-control"
              style="width: 150px"
              pInputText
              type="date"
              formControlName="admissiondate"
              [readonly]="data.pageType === 'graduateList'"
            /> -->
          </td>
          <td class="p-2 text-nowrap">
            <input
              class="form-control"
              style="width: 175px"
              pInputText
              #idcard
              maxlength="13"
              type="text"
              formControlName="idcardno"
              readonly
            />
          </td>
          <td class="p-2 text-nowrap">
            <input
              class="form-control"
              style="width: 175px"
              pInputText
              #passport
              type="text"
              formControlName="passportno"
              readonly
            />
          </td>

          <td class="p-2 text-nowrap" *ngIf="data.pageType === 'admissionList'">
            <select
              class="form-select"
              style="width: 150px"
              formControlName="nationality"
              [attr.disabled]="control.value.locked ? '' : null"
            >
              <option value="null" selected hidden disabled>
                กรุณาเลือก
              </option>
              <option
                *ngFor="let nation of data.nationality"
                [value]="nation.nationId"
              >
                {{ nation.nationName }}
              </option>
            </select>
          </td>

          <td class="p-2 text-nowrap">
            <select
              class="form-select"
              [attr.disabled]="data.pageType === 'graduateList' || control.value.locked ? '' : null"
              formControlName="prefixth"
            >
              <option value="null" selected hidden disabled>
                กรุณาเลือก
              </option>
              <option
                *ngFor="let ThPrefix of data.ThPrefixes"
                [value]="ThPrefix.id"
              >
                {{ ThPrefix.name_th }}
              </option>
            </select>
          </td>

          <td class="p-2 text-nowrap">
            <input
              class="form-control"
              style="width: 150px"
              pInputText
              type="text"
              formControlName="firstnameth"
              [readonly]="data.pageType === 'graduateList' || control.value.locked"
            />
          </td>
          <td class="p-2 text-nowrap">
            <input
              class="form-control"
              style="width: 150px"
              pInputText
              type="text"
              formControlName="lastnameth"
              [readonly]="data.pageType === 'graduateList' || control.value.locked"
            />
          </td>
          <td class="p-2 text-nowrap">
            <select
              class="form-select"
              [attr.disabled]="data.pageType === 'graduateList' || control.value.locked ? '' : null"
              formControlName="prefixen"
            >
              <option value="null" selected hidden disabled>
                กรุณาเลือก
              </option>
              <option
                *ngFor="let EngPrefix of data.EngPrefixes"
                [value]="EngPrefix.id"
              >
                {{ EngPrefix.name_en }}
              </option>
            </select>
          </td>

          <td class="p-2 text-nowrap">
            <input
              class="form-control"
              style="width: 150px"
              pInputText
              type="text"
              formControlName="firstnameen"
              [readonly]="data.pageType === 'graduateList' || control.value.locked"
            />
          </td>

          <td class="p-2 text-nowrap">
            <input
              class="form-control"
              style="width: 150px"
              pInputText
              type="text"
              formControlName="middlenameen"
              [readonly]="data.pageType === 'graduateList' || control.value.locked"
            />
          </td>

          <td class="p-2 text-nowrap">
            <input
              class="form-control"
              style="width: 150px"
              pInputText
              type="text"
              formControlName="lastnameen"
              [readonly]="data.pageType === 'graduateList' || control.value.locked"
            />
          </td>

          <td class="p-2 text-nowrap">
            <input
              class="form-control"
              style="width: 150px"
              pInputText
              type="text"
              maxlength="10"
              formControlName="phone"
              [readonly]="data.pageType === 'graduateList' || control.value.locked"
            />
          </td>
          <td class="p-2 text-nowrap">
            <div class="d-flex align-items-center">
              <input
                [matDatepicker]="pickerbirthdate"
                style="width: 150px"
                autocomplete="off"
                class="form-control form-date"
                formControlName="birthdate"
                [readonly]="data.pageType === 'graduateList' || control.value.locked"
              />
              <mat-datepicker-toggle
                class="button-date"
                matSuffix
                [for]="pickerbirthdate"
              ></mat-datepicker-toggle>
              <mat-datepicker 
                #pickerbirthdate
                [disabled]="data.pageType === 'graduateList' || control.value.locked"></mat-datepicker>
            </div>
            <!-- <input
              class="form-control"
              style="width: 150px"
              pInputText
              type="date"
              formControlName="birthdate"
              [readonly]="data.pageType === 'graduateList'"
            /> -->
          </td>

          <td class="p-2 text-nowrap">
            <div
              *ngIf="data.pageType === 'admissionList'"
              role="button"
              class="text-orange text-decoration-underline whitespace-nowrap"
              [pRowToggler]="control"
              (click)="autoScroll()"
            >
              รายละเอียดที่อยู่
            </div>

            <div
              class="text-orange text-decoration-underline whitespace-nowrap"
              role="button"
              *ngIf="data.pageType === 'graduateList'"
              (click)="viewAdress(control.value.address)"
            >
              รายละเอียดที่อยู่
            </div>
          </td>

          <td class="p-2 text-nowrap" *ngIf="data.pageType === 'admissionList'">
            <div
              class="text-orange text-decoration-underline whitespace-nowrap"
              role="button"
              (click)="insertSubject(control.value.subjects, ri, control.value.locked)"
            >
              รายวิชา
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="rowexpansion" let-control let-ii="rowIndex">
        <tr [formGroupName]="ii">
          <td></td>
          <td colspan="4">
            <form [formGroup]="control.controls.address">
              <ksp-form-address-table
                id="address-info"
                formControlName="addressInfo"
                [disabledAll]="control.value.locked"
              ></ksp-form-address-table>
            </form>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</form>
<div class="d-flex justify-content-end mt-3">
  <button
    matDialogClose
    type="button"
    class="btn border-primary text-primary"
  >
    ปิด
  </button>
</div>